<h1>Docker Compose, adding PostgreSQL</h1>

<p>In my <a class="blog_prev" href="./prev" title="Previous blog post">previous post</a> I developed a standalone <a href="https://www.postgresql.org/" title="PostgreSQL is a powerful, open source object-relational database system">PostgreSQL</a> <a href="https://hub.docker.com/_/postgres/" title="Docker Hub official postgres image">Docker container</a>. The implementation was bare-bones though. Therefore my goal for this post is not only to make this container part of my <a href="#" title="" onclick="navBlog.anchorAction(event, 'dkr_compose_pt1.xhtml')">Docker Compose project</a> but also to:</p>

<ol>
   <li>add a SQL initialization script and</li>
   <li>resolve the "no password ... set" warning in the container's log.</li>
</ol>

<p>My previous code repository had a SQL initialization script as well. It was located at the bottom of file <a href="http://hdr.is-a-geek.com/svn/dnbdpl/node.js/dnb_dpl_objs.js">dnb_dpl_objs.js</a>. Directory postgres/SQL is the ideal location in my Docker Compose project to create a dedicated file for this purpose. So first: <code>cd dnb_dpl_v2/postgres</code>... and then create directory SQL: <code>mkdir SQL &amp;&amp; cd $_</code> The file containing the <a href="https://en.wikipedia.org/wiki/Data_definition_language" title="Data Definition Language">DDL statements</a> for the creation of the database structures is named init.sql: <code>vim init.sql</code>The first version of <a href="http://hdr.is-a-geek.com/svn/dnb_dpl_v2/postgres/sql/init.sql?p=5" title="1st version of SQL initialization script">init.sql</a> is basically just a copy of the SQL statements from file <a href="http://hdr.is-a-geek.com/svn/dnbdpl/node.js/dnb_dpl_objs.js">dnb_dpl_objs.js</a>. However, in the dockerized environment, it is my intention to use both the out-of-the-box provided database (i.e. postgres) and database user (i.e. postgres as well). Consequently, the CREATE DATABASE &amp; CREATE USER statements from the original SQL script are no longer needed.</p>

<p>To make the script part of the Docker image go one directory up: <code>cd ..</code>... and add the following line to the Dockerfile (click to see <a href="http://hdr.is-a-geek.com/svn/dnb_dpl_v2/postgres/Dockerfile?p=5" title="Dockerfile before adding the COPY instruction">before</a> / <a href="http://hdr.is-a-geek.com/svn/dnb_dpl_v2/postgres/Dockerfile?p=5" title="Dockerfile after adding the COPY instruction">after</a>): <code>COPY ./SQL/init.sql /docker-entrypoint-initdb.d/10-init.sql</code>The required database structures will now be created automatically when the PostgreSQL database is first run: <img src="/dev/blog/imgs/pg_ddl_auto.png" alt="PostgreSQL initialization script on startup" style="margin-top:1.0em" /></p>

<p>Of course, the project's constituent parts are all tied together in the Docker Compose <a href="http://hdr.is-a-geek.com/svn/dnb_dpl_v2/docker-compose.yml?p=6" title="Docker Compose yml file">YAML</a> file. A new service, labelled dnb_dpl_postgres, is added to this file to make PostgreSQL part of the multi-container application. <img src="/dev/blog/imgs/dkr_cmps_rev_5_6.png" alt="docker-compose.yml revision 5 and 6 compared" style="margin: 1em auto" />The environment variable POSTGRES_PASSWORD resolves the "no password ... set" warning. Please make sure this variable is defined in <a href="https://docs.docker.com/compose/environment-variables/" title="Environment variables in Docker Compose">file .env</a> (more <a href="https://gist.github.com/hdr1001/1536299d7732087af52919cdfa9c11f9" title="Deploy a containerized D&amp;B Direct+ dev stack">here</a>).</p>

<p>I have introduced configuration parameter <a href="https://docs.docker.com/compose/compose-file/#depends_on" title="Docker Compose service dependencies">depends_on</a> in the latest version of the yml file as well. This to ensure that the database is started first, followed by the Node.js application and, lastly, the reverse proxy server.</p>

