<h1>Docker Compose, 100% up-n-runnin'</h1>

<p>The containers defined in my Docker Compose project are all, either directly or indirectly, connected. The connection between Apache and Node.js is described in <a href="#" title="Adding SSL client authentication to Dockerized Apache" onclick="navBlog.anchorAction(event, 'docker_pt4.xhtml')">this blog post</a>. The <a href="#" title="Adding a Node.js container" onclick="navBlog.anchorAction(event, 'dkr_compose_pt2.xhtml')">Node.js container</a> is connected to the <a href="#" title="Integrating the PostgreSQL container" onclick="navBlog.anchorAction(event, 'dkr_compose_pt4.xhtml')">PostgreSQL container</a> and the <a href="https://directplus.documentation.dnb.com/" title="D&amp;B Direct+ API">D&amp;B Direct+ API</a> as well. Both connections are made based on parameters recorded in dedicated JSON files. Below a screenshot of the JavaScript code in which a database connection pool is instantiated using the parameters from file <a href="http://hdr.is-a-geek.com/svn/dnb_dpl_v2/node/creds/pg.json" title="Configuration file pg.json">pg.json</a>: <img src="/dev/blog/imgs/node_pg_conn.png" alt="JavaScript code connection to PostgreSQL" style="margin:1.0em auto" />The PostgreSQL connection parameters are almost all fixed: <img src="/dev/blog/imgs/pg_conn_prms.png" alt="PostgreSQL connection parameters" style="margin:1.0em auto" />The password property is the (obvious) exception. The value specified in the configuration file is merely a placeholder. In the <a href="http://hdr.is-a-geek.com/svn/dnb_dpl_v2/node/Dockerfile?p=7" title="Using sed to replace the password value">Node.js Dockerfile</a> this entry is replaced with the proper value using <a href="https://www.gnu.org/software/sed/" title="GNU sed">sed</a>: <img src="/dev/blog/imgs/node_dkr_file_pg.png" alt="Using sed to replace the password placeholder" style="margin:1.0em auto" />The value for argument node_pg_pwd is passed into the Dockerfile from the <a href="http://hdr.is-a-geek.com/svn/dnb_dpl_v2/docker-compose.yml?p=7" title="Docker Compose project file">docker-compose.yml</a> file: <img src="/dev/blog/imgs/dkr_cmps_node_args.png" alt="" style="margin:1.0em auto" />Ultimately the stack's private configuration parameters are derived from the <a href="https://docs.docker.com/compose/environment-variables/" title="Docker Compose environment variables">.env file</a>. This is a hidden file which is stored in the same directory as the Docker Compose YAML file. It is my intention to keep track of all the steps necessary to download, build &amp; start the entire stack in <a href="https://gist.github.com/hdr1001/1536299d7732087af52919cdfa9c11f9" title="Instructions on how to deploy my D&amp;B Direct+ Docker Compose project">this gist</a> on GitHub. Part of the document is an exhaustive list of the Docker Compose environment variables: <img src="/dev/blog/imgs/dkr_cmps_env.png" alt="Docker Compose private configuration variables" style="margin:1.0em auto" /><strong>Note of caution:</strong> always be careful with the data contained in the .env file! It holds information which should not be shared willy-nilly.</p>

<p>The D&amp;B Direct+ credentials are processed in much the same way as the PostgreSQL connection parameters. If you want to know more look for a reference to file <a href="http://hdr.is-a-geek.com/svn/dnb_dpl_v2/node/creds/dpl.json?p=8" title="D&amp;B Direct+ credentials">dpl.json</a> in the JavaScript code file <a href="http://hdr.is-a-geek.com/svn/dnb_dpl_v2/node/src/dnb_dpl_objs.js?p=8" title="D&amp;B Direct+ Node.js object code">dnb_dpl_objs.js</a>. As before the <a href="http://hdr.is-a-geek.com/svn/dnb_dpl_v2/node/Dockerfile?p=8" title="Node.js Docker container configuration file">Dockerfile</a> contains instructions to substitude the placeholder values with the appropriate values. The D&amp;B Direct+ credentials are, in the end, sourced from the <a href="https://gist.github.com/hdr1001/1536299d7732087af52919cdfa9c11f9" title="Instructions on how to deploy my D&amp;B Direct+ Docker Compose project">.env file</a> and passed into the Node.js Dockerfile via the project's <a href="http://hdr.is-a-geek.com/svn/dnb_dpl_v2/docker-compose.yml?p=7" title="Docker Compose project file">Docker Compose YAML file</a>.</p>

<p>Of course I was curious whether, with the entire infrastructure in place &amp; the connections between the containers established, I could get my Direct+ custom endpoints, objects, etc. up-n-running. So I began porting the JavaScript code from the <a href="http://hdr.is-a-geek.com/svn/dnbdpl/" title="Previous implementation of Direct+ API on Node.js">previous repository</a> to the <a href="http://hdr.is-a-geek.com/svn/dnb_dpl_v2" title="Containerized implementation of Direct+ API on Node.js">new one</a>. Basically this turned out to be a smooth process but, upon start-up, the instantiation of the D&amp;B Direct+ authentication token object proved to be an issue. <img src="/dev/blog/imgs/prev_token_ini.png" alt="Authentication token instantiation on application start-up" style="margin:1.0em auto" />When I remarked this line of code the entire stack would start just fine but with the instantiation instruction included the Node.js container would log errors &amp; fail to start. It goes without saying that, for a properly functioning application, a valid authentication token is needed.</p>

<p>In first instance, while analyzing the issue, I ended up reading an article titled "<a href="http://bit.ly/2FgGWK8" title="Docker Compose health check">Making your web container wait till your database container is healthy</a>". This article put forward the correct diagnosis of the issue but, unfortunately, the solution proposed is <a href="https://docs.docker.com/compose/compose-file/#depends_on">no longer supported</a> in Docker Compose <a href="https://docs.docker.com/compose/compose-file/compose-versioning/" title="Compose file version">version 3</a>. The <a href="https://docs.docker.com/" title="Docker Documentation">Docker docs site</a> includes <a href="https://docs.docker.com/compose/startup-order/" title="Control startup and shutdown order in Compose">an article</a> which explains why support for the <i>condition</i> form of <i>depends_on</i> is discontinued. In short the reasoning behind this is that an application needs to be resilient enough to recover from situations in which, for instance, a database is temporarily unavailable. Currently this level of resilience is not my priority and therefore I opted for a more pragmatic solution. I found out that, on start-up, my PostgreSQL container is ready to process requests after a three second delay. This means that I am good to go in case I execute the token instantiation after a 3000 millisecond timeout: <img src="/dev/blog/imgs/token_ini_delay.png" alt="Use setTimeout to delay authentication token instantiation" style="margin:1.0em auto" />I think it is importantant to mention that, at the time of this writing, I have had a cloud instance of my Docker Compose application up-n-running for several weeks now and it has not given me any issue whatsoever.</p>

<p>While porting my code over to the <a href="http://hdr.is-a-geek.com/svn/dnb_dpl_v2" title="My new SVN repository">new repository</a> I have made the most significant changes to file dnb_dpl_objs.js. You can compare <a href="http://hdr.is-a-geek.com/svn/dnbdpl/node.js/dnb_dpl_objs.js" title="Hans de Rooij's D&amp;B Direct+ Node.js object code (previous version)">old</a> and <a href="http://hdr.is-a-geek.com/svn/dnb_dpl_v2/node/src/dnb_dpl_objs.js?p=8" title="Hans de Rooij's D&amp;B Direct+ Node.js object code (new version)">new</a> line-by-line using <a href="https://www.diffnow.com/compare-urls" title="DiffNow lets you compare text files, documents, binary files, and archives">DiffNow</a>: <img src="/dev/blog/imgs/diff_now.png" alt="DiffNow example file dnb_dpl_objs.js" style="margin:1.0em auto" />When I wrote this post my previous repository was at revision 18 &amp; the current one at revision 8. You can use query parameter p to retrieve a specific revision of a code file.</p>

