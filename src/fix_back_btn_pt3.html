<h1>Don't break the back button! (pt. III)</h1>

<p>Event popstate is fired when the active history entry changes. In normal usage scenarios this can be equated to "when the user clicks either the back or forward button". In my blog's <a href="http://hdr.is-a-geek.com/dev/blog/js/a2blog_main.js" title="Blog JavaScript code">JavaScript code</a> this event is captured using the jQuery method <a href="https://learn.jquery.com/events/handling-events/" title="jQuery handling events">.on()</a>. <code>$(window).on("popstate", function(event) { ...</code>In the popstate event handler the active state object on the history stack is the state associated with the page which is about to become active (i.e. not the state of the page which was active when the back button was clicked). Therefore the new value of the blog's current index can simply be read from variable hdr_idx as previously stored (see <a href="#" title="Back button, part 1" onclick="navBlog.anchorAction(event, 'fix_back_btn_pt1.xhtml')">pt. I</a> &amp; <a href="#" title="Back button, part 2" onclick="navBlog.anchorAction(event, 'fix_back_btn_pt2.xhtml')">pt. II</a>) on the history stack: <code>var restore_idx = event.originalEvent.state.hdr_idx</code>Click <a href="https://stackoverflow.com/questions/7860960/popstate-returns-event-state-is-undefined" title="popstate returns event.state is undefined">here</a> for more information about why originalEvent is needed to access the standard DOM event object instead of the jQuery one.</p>

<p>The popstate event handler invokes method popStateAction on object navBlog. Because the value of the new current index (i.e. currIdx) is passed immediately into this function the file name of the appropriate post has to be derived from it. This is done in function idxPost. All the information needed to call function replaceContent is now available. Moving back or forward is all about traversing the history stack (not changing it) and therefore function replaceContent is called with parameter doPushState set to false.</p>

<p>All browsers handle navigation between blog posts exactly the same but please be aware that Firefox deals with returning from an external link differently than Chrome &amp; Edge. In short you could say that Firefox preserves state perfectly whereas Chrome &amp; Edge reload (probably from cache) the entire page. As a result, in Chrome &amp; Edge, object navBlog is re-instantiated and, as part of this process, the JSON describing my blog's content is read again. Originally the code for retrieving the JSON, by default, also initialised variable currIdx and documented application state properly (replaceState, see <a href="#" title="Back button, part 1" onclick="navBlog.anchorAction(event, 'fix_back_btn_pt1.xhtml')">pt. I</a>). This code is still relevant in case a user first issues an HTTP GET request for my blog. However, for Chrome &amp; Edge, additional, conditional code was needed to handle the use case in which a user clicks the back button to return to my blog after visiting an external site. For more information about the relevant JavaScript, just visit the <a href="https://gist.github.com/hdr1001/dfb02fc5b2b88bc3186084d8db7582d8" title="Blog navigation on load">GitHub Gist</a> I've created to document the code in question &amp; its revisions. BTW, as an unforeseen consequence of these changes, page refresh also works properly now!</p>

